<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actions History - X-AutoRaider</title>
    <script src="components/navbar.js"></script>
    <script src="components/floating-automation-button.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
            min-height: 100vh;
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding-top: 80px;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .container-fluid {
            padding: 20px;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .header-card {
            background: linear-gradient(135deg, #1da1f2 0%, #0d8bd9 100%);
            color: white;
        }
        
        
        .stats-section {
            margin-bottom: 25px;
        }
        
        .filter-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .action-card {
            border-left: 4px solid;
            margin-bottom: 15px;
            transition: transform 0.2s ease;
        }
        
        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .action-like { border-left-color: #e74c3c; }
        .action-retweet { border-left-color: #27ae60; }
        .action-reply { border-left-color: #3498db; }
        
        .action-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        .icon-like { background: #e74c3c; }
        .icon-retweet { background: #27ae60; }
        .icon-reply { background: #3498db; }
        
        .tweet-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            border-left: 3px solid #1da1f2;
        }
        
        .account-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .date-badge {
            background: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
        }
        
        .metric-card, .analytics-card, .quality-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .metric-card:hover, .analytics-card:hover, .quality-card:hover {
            transform: translateY(-2px);
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #1da1f2;
            margin-top: 5px;
        }
        
        .analytics-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .stats-row {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .no-actions {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .btn-filter {
            border-radius: 20px;
            padding: 8px 20px;
            margin: 5px;
        }
        
        .btn-filter.active {
            background: #1da1f2;
            border-color: #1da1f2;
            color: white;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding-top: 60px;
            }
            
            .container-fluid {
                padding: 10px;
            }
            
            .card-body {
                padding: 15px;
            }
            
            .stats-row {
                padding: 10px;
            }
            
            .stat-number {
                font-size: 20px;
            }
            
            .filter-section {
                padding: 15px;
            }
            
            .btn-filter {
                padding: 6px 15px;
                margin: 3px;
                font-size: 14px;
            }
            
            .action-card {
                margin-bottom: 10px;
            }
            
            .action-icon {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding-top: 50px;
            }
            
            .container-fluid {
                padding: 5px;
            }
            
            .card-body {
                padding: 10px;
            }
            
            .stats-row {
                padding: 8px;
            }
            
            .stat-number {
                font-size: 18px;
            }
            
            .filter-section {
                padding: 10px;
            }
            
            .btn-filter {
                padding: 5px 12px;
                margin: 2px;
                font-size: 12px;
            }
            
            .btn-sm {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .action-icon {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
            
            .tweet-preview {
                padding: 8px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 320px) {
            .container-fluid {
                padding: 3px;
            }
            
            .card-body h1 {
                font-size: 1.5em;
            }
            
            .stat-number {
                font-size: 16px;
            }
            
            .btn-filter {
                padding: 4px 10px;
                font-size: 11px;
            }
        }

        /* Floating buttons - unified styling */
        .floating-btn {
            position: fixed;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .floating-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .automation-control-btn {
            bottom: 30px;
            right: 30px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .automation-control-btn.stop {
            background: linear-gradient(45deg, #dc3545, #e74c3c);
            animation: pulse-running 2s ease-in-out infinite;
        }

        @keyframes pulse-running {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 6px 25px rgba(220, 53, 69, 0.7);
                transform: scale(1.05);
            }
        }

        @media (max-width: 768px) {
            .floating-btn {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
            
            .automation-control-btn {
                bottom: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    
    <div class="container-fluid">
        <!-- Header -->
        <div class="card header-card">
            <div class="card-body text-center">
                <h1 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    Raid Action History & Analytics
                </h1>
                <p class="mb-0 mt-2">Detailed tracking of all automated alpha raids and advanced performance analytics</p>
            </div>
        </div>

        <!-- Statistiques -->
        <div class="stats-row">
            <div class="row">
                <div class="col-md-3">
                    <div class="stat-item">
                        <div class="stat-number text-danger" id="totalLikes">0</div>
                        <div class="stat-label">Likes</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-item">
                        <div class="stat-number text-success" id="totalRetweets">0</div>
                        <div class="stat-label">Retweets</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-item">
                        <div class="stat-number text-primary" id="totalReplies">0</div>
                        <div class="stat-label">Alpha Replies</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-item">
                        <div class="stat-number text-info" id="totalActions">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtres et Export -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-person-circle me-1"></i>
                        Raid Wallet
                    </label>
                    <select class="form-select" id="accountFilter">
                        <option value="">All raid wallets</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">
                        <i class="bi bi-calendar-date me-1"></i>
                        Start Date
                    </label>
                    <input type="date" class="form-control" id="dateFromFilter">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">
                        <i class="bi bi-calendar-date me-1"></i>
                        End Date
                    </label>
                    <input type="date" class="form-control" id="dateToFilter">
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">Quick Filters</label>
                    <div class="d-flex flex-column gap-1">
                        <button class="btn btn-outline-secondary btn-sm" onclick="filterByPeriod('today')">
                            <i class="bi bi-calendar-day me-1"></i> Today
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="filterByPeriod('week')">
                            <i class="bi bi-calendar-week me-1"></i> This Week
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="filterByPeriod('month')">
                            <i class="bi bi-calendar-month me-1"></i> This Month
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Actions</label>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-primary btn-sm" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                        </button>
                        <button class="btn btn-outline-info btn-sm" id="toggleCharts" onclick="toggleChartsView()">
                            <i class="bi bi-bar-chart me-1"></i> Analytics
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportData('csv')">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i> CSV
                        </button>
                        <button class="btn btn-info btn-sm" onclick="exportData('json')">
                            <i class="bi bi-file-earmark-code me-1"></i> JSON
                        </button>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <div class="d-flex flex-wrap">
                        <button class="btn btn-outline-primary btn-filter active" data-action="all">
                            All Actions
                        </button>
                        <button class="btn btn-outline-danger btn-filter" data-action="like">
                            <i class="bi bi-heart-fill me-1"></i> Likes
                        </button>
                        <button class="btn btn-outline-success btn-filter" data-action="retweet">
                            <i class="bi bi-arrow-repeat me-1"></i> Retweets
                        </button>
                        <button class="btn btn-outline-primary btn-filter" data-action="reply">
                            <i class="bi bi-chat-fill me-1"></i> Alpha Replies
                        </button>
                        <button class="btn btn-secondary ms-auto" onclick="clearFilters()">
                            <i class="bi bi-x-circle me-1"></i> Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nouvelles sections Analytics Avancés -->
        <div class="analytics-section">
            <h5><i class="bi bi-speedometer2 me-2"></i>Métriques de Performance</h5>
            <div id="performanceMetrics">
                <div class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    Chargement des métriques...
                </div>
            </div>
        </div>
        
        <div class="analytics-section">
            <h5><i class="bi bi-graph-up-arrow me-2"></i>Analytics Comportementales</h5>
            <div id="behavioralAnalytics">
                <div class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    Chargement des analytics...
                </div>
            </div>
        </div>
        
        <div class="analytics-section">
            <h5><i class="bi bi-shield-check me-2"></i>Métriques de Qualité</h5>
            <div id="qualityMetrics">
                <div class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    Chargement de la qualité...
                </div>
            </div>
        </div>
        
        <div class="analytics-section">
            <h5><i class="bi bi-lightbulb me-2"></i>Recommandations Intelligentes</h5>
            <div id="recommendations">
                <div class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    Chargement des recommandations...
                </div>
            </div>
        </div>

        <!-- Section Analytics (masquée par défaut) -->
        <div id="analyticsSection" style="display: none;">
            <!-- Graphiques temporels -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-graph-up me-2"></i>Temporal Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <canvas id="hourlyChart" width="400" height="300"></canvas>
                            <h6 class="text-center mt-2">Actions per Hour</h6>
                        </div>
                        <div class="col-md-4">
                            <canvas id="dailyChart" width="400" height="300"></canvas>
                            <h6 class="text-center mt-2">Actions per Day</h6>
                        </div>
                        <div class="col-md-4">
                            <canvas id="weeklyChart" width="400" height="300"></canvas>
                            <h6 class="text-center mt-2">Actions per Week</h6>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Heatmap -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="bi bi-grid-3x3-gap me-2"></i>Activity Heatmap</h5>
                </div>
                <div class="card-body">
                    <div id="heatmapContainer">
                        <canvas id="heatmapChart" width="800" height="200"></canvas>
                        <p class="text-center mt-2 text-muted">Action intensity by day of week and hour</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zone de chargement -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading raid history...</p>
        </div>

        <!-- Liste des actions -->
        <div id="actionsContainer">
            <!-- Les actions seront chargées ici -->
        </div>

        <!-- Message si aucune action -->
        <div class="no-actions" id="noActions" style="display: none;">
            <i class="bi bi-inbox" style="font-size: 48px; color: #dee2e6;"></i>
            <h4 class="mt-3">No Raid Actions Found</h4>
            <p>No actions match the selected filters. Try adjusting your search criteria.</p>
        </div>
    </div>

    <!-- Automation Control Button -->
    <button class="floating-btn automation-control-btn" id="automationControlBtn" onclick="toggleAutomation()" title="Lancer/Arrêter l'automation">
        <i class="fas fa-play" id="automationIcon"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ===== AUTOMATION CONTROL FUNCTIONS =====
        const API_BASE_URL = window.location.origin;

        // Toggle automation function for floating button
        async function toggleAutomation() {
            const btn = document.getElementById('automationControlBtn');
            const icon = document.getElementById('automationIcon');
            
            if (!btn || !icon) {
                console.error('[TOGGLE] Button elements not found');
                return;
            }
            
            try {
                btn.disabled = true;
                const response = await fetch(`${API_BASE_URL}/api/automation-status`);
                const currentData = await response.json();
                
                // Toggle automation
                const toggleResponse = await fetch(`${API_BASE_URL}/api/automation-status`, { method: 'POST' });
                const newData = await toggleResponse.json();
                
                // Update button appearance immediately
                updateAutomationButton(newData.isAutomationEnabled);
                
                // Show notification
                const message = newData.isAutomationEnabled ? 'Automation démarrée ✅' : 'Automation arrêtée ⏹️';
                console.log('[TOGGLE]', message);
                
            } catch (error) {
                console.error('Erreur toggle automation:', error);
            } finally {
                btn.disabled = false;
            }
        }

        // Update automation button appearance
        function updateAutomationButton(isRunning) {
            const btn = document.getElementById('automationControlBtn');
            const icon = document.getElementById('automationIcon');
            
            if (!btn || !icon) return;
            
            if (isRunning) {
                btn.classList.add('stop');
                btn.title = 'Arrêter l\'automation';
                icon.className = 'fas fa-stop';
            } else {
                btn.classList.remove('stop');
                btn.title = 'Lancer l\'automation';
                icon.className = 'fas fa-play';
            }
        }

        // Load automation status on page load
        async function loadAutomationStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/automation-status`);
                const data = await response.json();
                
                const isEnabled = data.isAutomationEnabled || data.isEnabled || false;
                updateAutomationButton(isEnabled);
                
            } catch (error) {
                console.error('[LOAD] Status loading error:', error);
                updateAutomationButton(false);
            }
        }

        // Initialize automation status when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadAutomationStatus, 500); // Small delay to ensure button is rendered
        });

        // ===== ACTIONS HISTORY FUNCTIONS =====
        let allActions = [];
        let accounts = [];
        let filteredActions = [];
        let timeStats = {};
        let heatmapData = {};
        let charts = {};

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadAccounts();
            loadActions();
            setupEventListeners();
        });

        // Charger les comptes
        async function loadAccounts() {
            try {
                const token = localStorage.getItem('clientToken');
                const response = await fetch('/api/accounts', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const responseText = await response.text();
                console.log('[ACCOUNTS] Response:', responseText.substring(0, 200));
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('[ACCOUNTS] Failed to parse JSON:', parseError);
                    console.error('[ACCOUNTS] Response text:', responseText);
                    throw new Error('Invalid JSON response from /api/accounts');
                }
                
                // Vérifier que les données sont un tableau
                if (Array.isArray(data)) {
                    accounts = data;
                } else if (data && Array.isArray(data.accounts)) {
                    accounts = data.accounts;
                } else {
                    console.warn('Format de données comptes inattendu:', data);
                    accounts = [];
                    return;
                }
                
                const accountSelect = document.getElementById('accountFilter');
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `@${account.username}`;
                    accountSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading accounts:', error);
                accounts = []; // Initialiser comme tableau vide en cas d'erreur
            }
        }

        // Charger l'historique des actions
        async function loadActions() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('actionsContainer').innerHTML = '';
            
            console.log('=== STARTING LOAD ACTIONS ===');
            
            try {
                console.log('Fetching /api/actions-history...');
                const token = localStorage.getItem('clientToken');
                const response = await fetch('/api/actions-history', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response received, parsing...');
                
                allActions = parseActionsData(data);
                filteredActions = [...allActions];
                
                // Stocker les données d'analytics
                timeStats = data.timeStats || {};
                heatmapData = data.heatmapData || {};
                
                console.log('=== DEBUG ANALYTICS ===');
                console.log('Full API Response:', data);
                console.log('TimeStats loaded:', timeStats);
                console.log('HeatmapData loaded:', heatmapData);
                console.log('Actions count:', allActions.length);
                console.log('======================');
                
                updateStatistics();
                renderActions();
                
            } catch (error) {
                console.error('Error loading history:', error);
                showError('Error loading actions history');
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        // Parser les données d'actions
        function parseActionsData(data) {
            const actions = [];
            
            // 🔄 NOUVELLE LOGIQUE : Utiliser les données de l'API enrichie
            if (data && data.actions && Array.isArray(data.actions)) {
                // Utiliser directement les actions formatées de l'API avec toutes les données
                return data.actions.map(action => ({
                    tweetId: action.tweetId,
                    accountId: action.accountId,
                    accountUsername: action.accountUsername || action.username,
                    username: action.username || action.accountUsername,
                    actionType: action.actionType,
                    timestamp: new Date(action.timestamp),
                    tweetData: action.tweetData || null,
                    targetUser: action.targetUser,
                    tweetText: action.tweetText,
                    details: action.details
                }));
            }
            
            // Fallback sur l'ancienne structure si nécessaire
            if (!data || !data.performedActions) {
                console.warn('Invalid or empty actions-history data:', data);
                return actions;
            }
            
            try {
                Object.entries(data.performedActions).forEach(([tweetId, accounts]) => {
                    if (!accounts || typeof accounts !== 'object') {
                        console.warn('Invalid account data for tweet:', tweetId);
                        return;
                    }
                    
                    Object.entries(accounts).forEach(([accountId, actionTypes]) => {
                        if (!actionTypes || typeof actionTypes !== 'object') {
                            console.warn('Invalid action types for account:', accountId);
                            return;
                        }
                        
                        Object.entries(actionTypes).forEach(([actionType, timestamp]) => {
                            if (!timestamp) {
                                console.warn('Invalid timestamp for action:', actionType);
                                return;
                            }
                            
                            const account = getAccountById(accountId);
                            actions.push({
                                tweetId,
                                accountId,
                                accountUsername: account ? account.username : `Account ${accountId}`,
                                actionType,
                                timestamp: new Date(timestamp),
                                tweetData: data.tweetsData ? data.tweetsData[tweetId] : null
                            });
                        });
                    });
                });
            } catch (error) {
                console.error('Error parsing data:', error);
            }
            
            // Trier par date décroissante (plus récent en premier)
            return actions.sort((a, b) => b.timestamp - a.timestamp);
        }

        // Obtenir un compte par ID
        function getAccountById(accountId) {
            if (!Array.isArray(accounts)) {
                console.warn('accounts is not an array:', accounts);
                return null;
            }
            return accounts.find(account => account.id === accountId);
        }

        // Mettre à jour les statistiques
        function updateStatistics() {
            const stats = {
                likes: filteredActions.filter(a => a.actionType === 'like').length,
                retweets: filteredActions.filter(a => a.actionType === 'retweet').length,
                replies: filteredActions.filter(a => a.actionType === 'reply').length
            };
            
            document.getElementById('totalLikes').textContent = stats.likes;
            document.getElementById('totalRetweets').textContent = stats.retweets;
            document.getElementById('totalReplies').textContent = stats.replies;
            document.getElementById('totalActions').textContent = stats.likes + stats.retweets + stats.replies;
        }

        // Afficher les actions
        function renderActions() {
            const container = document.getElementById('actionsContainer');
            const noActions = document.getElementById('noActions');
            
            if (filteredActions.length === 0) {
                container.innerHTML = '';
                noActions.style.display = 'block';
                return;
            }
            
            noActions.style.display = 'none';
            
            const actionsHtml = filteredActions.map(action => createActionCard(action)).join('');
            container.innerHTML = actionsHtml;
        }

        // Créer une carte d'action
        function createActionCard(action) {
            const actionIcons = {
                like: { icon: 'bi-heart-fill', class: 'icon-like', label: 'Like' },
                retweet: { icon: 'bi-arrow-repeat', class: 'icon-retweet', label: 'Retweet' },
                reply: { icon: 'bi-chat-fill', class: 'icon-reply', label: 'Reply' }
            };
            
            const actionInfo = actionIcons[action.actionType];
            const formattedDate = action.timestamp.toLocaleString('fr-FR');
            const tweetUrl = `https://twitter.com/i/status/${action.tweetId}`;
            
            // Detailed information from API
            const influencerName = action.targetUser || 'Unknown Influencer';
            const tweetText = action.tweetText || action.details || '';
            const displayText = tweetText.length > 200 ? tweetText.substring(0, 200) + '...' : tweetText;
            
            return `
                <div class="card action-card action-${action.actionType}">
                    <div class="card-body">
                        <div class="row align-items-start">
                            <div class="col-auto">
                                <div class="action-icon ${actionInfo.class}">
                                    <i class="${actionInfo.icon}"></i>
                                </div>
                            </div>
                            <div class="col">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            <strong>${actionInfo.label}</strong> on tweet by 
                                            <span class="text-primary">@${influencerName}</span>
                                        </h6>
                                        <div class="mb-2">
                                            <span class="account-badge">Account: @${action.username || action.accountUsername}</span>
                                            <span class="date-badge ms-2">${formattedDate}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                ${tweetText ? `
                                <div class="tweet-preview mb-2">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="bi bi-person-circle me-1 text-muted"></i>
                                        <small class="text-muted">@${influencerName}</small>
                                    </div>
                                    <p class="mb-0">${displayText}</p>
                                </div>
                                ` : ''}
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="text-muted small">
                                        <i class="bi bi-twitter me-1"></i>
                                        ID: ${action.tweetId}
                                    </div>
                                    <div>
                                        <a href="${tweetUrl}" target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-box-arrow-up-right me-1"></i>
                                            View Tweet
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Créer un aperçu du tweet
        function createTweetPreview(tweetData) {
            if (!tweetData) return '';
            
            const text = tweetData.text ? tweetData.text.substring(0, 150) + (tweetData.text.length > 150 ? '...' : '') : 'Content not available';
            const author = tweetData.author_username || 'Unknown user';
            
            return `
                <div class="tweet-preview">
                    <small class="text-muted">
                        <i class="bi bi-person-circle me-1"></i>
                        @${author}
                    </small>
                    <p class="mb-0 mt-1">${text}</p>
                </div>
            `;
        }

        // Configuration des événements
        function setupEventListeners() {
            // Filtres de type d'action
            document.querySelectorAll('.btn-filter[data-action]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.btn-filter[data-action]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    applyFilters();
                });
            });

            // Filtres de date et compte
            document.getElementById('accountFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFromFilter').addEventListener('change', applyFilters);
            document.getElementById('dateToFilter').addEventListener('change', applyFilters);
        }

        // Appliquer les filtres
        function applyFilters() {
            const actionFilter = document.querySelector('.btn-filter[data-action].active').dataset.action;
            const accountFilter = document.getElementById('accountFilter').value;
            const dateFromFilter = document.getElementById('dateFromFilter').value;
            const dateToFilter = document.getElementById('dateToFilter').value;

            filteredActions = allActions.filter(action => {
                // Filtre par type d'action
                if (actionFilter !== 'all' && action.actionType !== actionFilter) {
                    return false;
                }

                // Filtre par compte
                if (accountFilter && action.accountId !== accountFilter) {
                    return false;
                }

                // Filtre par date
                if (dateFromFilter) {
                    const fromDate = new Date(dateFromFilter);
                    if (action.timestamp < fromDate) {
                        return false;
                    }
                }

                if (dateToFilter) {
                    const toDate = new Date(dateToFilter);
                    toDate.setHours(23, 59, 59, 999); // Fin de journée
                    if (action.timestamp > toDate) {
                        return false;
                    }
                }

                return true;
            });

            updateStatistics();
            renderActions();
        }

        // Effacer tous les filtres
        function clearFilters() {
            document.getElementById('accountFilter').value = '';
            document.getElementById('dateFromFilter').value = '';
            document.getElementById('dateToFilter').value = '';
            
            document.querySelectorAll('.btn-filter[data-action]').forEach(b => b.classList.remove('active'));
            document.querySelector('.btn-filter[data-action="all"]').classList.add('active');
            
            filteredActions = [...allActions];
            updateStatistics();
            renderActions();
        }

        // Afficher une erreur
        function showError(message) {
            const container = document.getElementById('actionsContainer');
            container.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
        }

        // Actualiser les données
        function refreshData() {
            loadActions();
        }

        // Fonctions pour les analytics
        function toggleChartsView() {
            const analyticsSection = document.getElementById('analyticsSection');
            const toggleBtn = document.getElementById('toggleCharts');
            
            if (analyticsSection.style.display === 'none') {
                analyticsSection.style.display = 'block';
                toggleBtn.innerHTML = '<i class="bi bi-list me-1"></i> List View';
                toggleBtn.classList.remove('btn-outline-info');
                toggleBtn.classList.add('btn-info');
                createCharts();
            } else {
                analyticsSection.style.display = 'none';
                toggleBtn.innerHTML = '<i class="bi bi-bar-chart me-1"></i> Analytics';
                toggleBtn.classList.remove('btn-info');
                toggleBtn.classList.add('btn-outline-info');
            }
        }

        function createCharts() {
            console.log('=== CREATING CHARTS ===');
            console.log('Available timeStats:', timeStats);
            console.log('Available heatmapData:', heatmapData);
            
            // Graphique par heure
            createHourlyChart();
            // Graphique par jour
            createDailyChart();
            // Graphique par semaine
            createWeeklyChart();
            // Heatmap
            createHeatmap();
            
            console.log('=== CHARTS CREATED ===');
        }

        function createHourlyChart() {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            if (charts.hourly) {
                charts.hourly.destroy();
            }
            
            const hours = Array.from({length: 24}, (_, i) => i);
            const data = hours.map(hour => timeStats.hourly?.[hour]?.total || 0);
            
            charts.hourly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours.map(h => h + 'h'),
                    datasets: [{
                        label: 'Actions',
                        data: data,
                        backgroundColor: 'rgba(29, 161, 242, 0.6)',
                        borderColor: 'rgba(29, 161, 242, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createDailyChart() {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            if (charts.daily) {
                charts.daily.destroy();
            }
            
            const days = Object.keys(timeStats.daily || {}).sort();
            const data = days.map(day => timeStats.daily[day].total);
            
            charts.daily = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days.map(d => new Date(d).toLocaleDateString('en-US')),
                    datasets: [{
                        label: 'Actions',
                        data: data,
                        backgroundColor: 'rgba(39, 174, 96, 0.2)',
                        borderColor: 'rgba(39, 174, 96, 1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function createWeeklyChart() {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            
            if (charts.weekly) {
                charts.weekly.destroy();
            }
            
            const weeks = Object.keys(timeStats.weekly || {}).sort();
            const data = weeks.map(week => timeStats.weekly[week].total);
            
            charts.weekly = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: weeks.map(w => `Week ${w}`),
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(231, 76, 60, 0.8)',
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(46, 204, 113, 0.8)',
                            'rgba(155, 89, 182, 0.8)',
                            'rgba(241, 196, 15, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function createHeatmap() {
            const canvas = document.getElementById('heatmapChart');
            const ctx = canvas.getContext('2d');
            
            // Nettoyer le canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const hours = Array.from({length: 24}, (_, i) => i);
            
            const cellWidth = canvas.width / 24;
            const cellHeight = canvas.height / 7;
            
            // Trouver la valeur max pour la normalisation
            const maxValue = Math.max(...Object.values(heatmapData || {}));
            
            // Dessiner la heatmap
            for (let day = 0; day < 7; day++) {
                for (let hour = 0; hour < 24; hour++) {
                    const value = heatmapData[`${day}_${hour}`] || 0;
                    const intensity = maxValue > 0 ? value / maxValue : 0;
                    
                    // Couleur basée sur l'intensité
                    const alpha = intensity * 0.8 + 0.1;
                    ctx.fillStyle = `rgba(29, 161, 242, ${alpha})`;
                    
                    ctx.fillRect(hour * cellWidth, day * cellHeight, cellWidth - 1, cellHeight - 1);
                    
                    // Texte si valeur > 0
                    if (value > 0) {
                        ctx.fillStyle = intensity > 0.5 ? 'white' : 'black';
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(value, hour * cellWidth + cellWidth/2, day * cellHeight + cellHeight/2 + 3);
                    }
                }
            }
            
            // Labels des jours
            ctx.fillStyle = 'black';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            for (let day = 0; day < 7; day++) {
                ctx.fillText(days[day], -5, day * cellHeight + cellHeight/2 + 4);
            }
            
            // Labels des heures
            ctx.textAlign = 'center';
            for (let hour = 0; hour < 24; hour += 2) {
                ctx.fillText(hour + 'h', hour * cellWidth + cellWidth/2, canvas.height + 15);
            }
        }

        // Export des données
        function exportData(format) {
            const currentFilters = new URLSearchParams();
            
            const actionFilter = document.querySelector('.btn-filter[data-action].active').dataset.action;
            if (actionFilter && actionFilter !== 'all') {
                currentFilters.append('type', actionFilter);
            }
            
            currentFilters.append('format', format);
            
            const url = `/api/actions-history/export?${currentFilters.toString()}`;
            
            // Créer un lien de téléchargement
            const link = document.createElement('a');
            link.href = url;
            link.download = `raid-actions-${new Date().toISOString().split('T')[0]}.${format}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Notification
            showNotification(`${format.toUpperCase()} export in progress...`, 'info');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove après 3 secondes
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Quick filter functions
        function filterByPeriod(period) {
            const now = new Date();
            let startDate;
            
            switch(period) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    const dayOfWeek = now.getDay();
                    startDate = new Date(now.getTime() - (dayOfWeek * 24 * 60 * 60 * 1000));
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                default:
                    return;
            }
            
            // Set date filters
            document.getElementById('dateFromFilter').value = startDate.toISOString().split('T')[0];
            document.getElementById('dateToFilter').value = now.toISOString().split('T')[0];
            
            // Apply filters
            applyFilters();
        }

        // Nouvelles fonctions pour analytics avancés
        async function loadAdvancedAnalytics() {
            try {
                const token = localStorage.getItem('clientToken');
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                };
                
                const [performance, behavioral, quality, recommendations] = await Promise.all([
                    fetch('/api/analytics/performance', { headers }).then(r => r.json()),
                    fetch('/api/analytics/behavioral', { headers }).then(r => r.json()),
                    fetch('/api/analytics/quality', { headers }).then(r => r.json()),
                    fetch('/api/analytics/recommendations', { headers }).then(r => r.json())
                ]);

                updatePerformanceMetrics(performance);
                updateBehavioralAnalytics(behavioral);
                updateQualityMetrics(quality);
                updateRecommendations(recommendations);
            } catch (error) {
                console.error('Erreur chargement analytics avancés:', error);
            }
        }

        function updatePerformanceMetrics(data) {
            if (!data.success || !data.data) return;
            
            const metrics = data.data;
            const container = document.getElementById('performanceMetrics');
            if (!container) return;

            // Valeurs par défaut sécurisées
            const conversionRate = Number((metrics.conversionRate || 0) * 100);
            const accountEfficiency = Number((metrics.accountEfficiency || 0) * 100);
            const velocity = Number(metrics.velocity || 0);
            const quotaROI = Number((metrics.quotaROI || 0) * 100);

            container.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <h6>Taux de Conversion</h6>
                            <div class="metric-value">${conversionRate.toFixed(1)}%</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <h6>Efficacité Comptes</h6>
                            <div class="metric-value">${accountEfficiency.toFixed(1)}%</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <h6>Vélocité</h6>
                            <div class="metric-value">${velocity.toFixed(1)} act/h</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <h6>ROI Quotas</h6>
                            <div class="metric-value">${quotaROI.toFixed(1)}%</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateBehavioralAnalytics(data) {
            if (!data.success || !data.data) return;
            
            const analytics = data.data;
            const container = document.getElementById('behavioralAnalytics');
            if (!container) return;

            // Valeurs par défaut sécurisées
            const optimalHour = Number((analytics.optimalTiming && analytics.optimalTiming.bestHour) || 12);
            const peakDay = (analytics.optimalTiming && analytics.optimalTiming.peakDay) || 'Lundi';
            const growth = Number((analytics.seasonalTrends && analytics.seasonalTrends.growth) || 0);
            const fatigueLevel = Number((analytics.accountFatigue && analytics.accountFatigue.averageLevel) || 0);

            container.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="analytics-card">
                            <h6><i class="bi bi-clock"></i> Timing Optimal</h6>
                            <p>Meilleure heure: <strong>${optimalHour}h</strong></p>
                            <p>Jour de pointe: <strong>${peakDay}</strong></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="analytics-card">
                            <h6><i class="bi bi-graph-up"></i> Tendances</h6>
                            <p>Croissance: <strong>${growth > 0 ? '+' : ''}${(growth * 100).toFixed(1)}%</strong></p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="analytics-card">
                            <h6><i class="bi bi-battery-half"></i> Fatigue Comptes</h6>
                            <p>Niveau moyen: <strong>${(fatigueLevel * 100).toFixed(0)}%</strong></p>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateQualityMetrics(data) {
            if (!data.success || !data.data) return;
            
            const metrics = data.data;
            const container = document.getElementById('qualityMetrics');
            if (!container) return;

            // Valeurs par défaut sécurisées
            const systemHealth = Number(metrics.systemHealth || 0);
            const actionQuality = Number(metrics.actionQuality || 0);
            const anomalyCount = Number(metrics.anomalyCount || 0);
            
            const healthColor = systemHealth > 0.8 ? 'success' : systemHealth > 0.6 ? 'warning' : 'danger';

            container.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="quality-card">
                            <h6><i class="bi bi-heart-pulse"></i> Santé Système</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-${healthColor}" style="width: ${(systemHealth * 100)}%"></div>
                            </div>
                            <small>${(systemHealth * 100).toFixed(1)}%</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="quality-card">
                            <h6><i class="bi bi-star"></i> Qualité Actions</h6>
                            <div class="metric-value">${(actionQuality * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="quality-card">
                            <h6><i class="bi bi-exclamation-triangle"></i> Anomalies</h6>
                            <div class="metric-value text-${anomalyCount > 0 ? 'danger' : 'success'}">${anomalyCount}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateRecommendations(data) {
            if (!data.success || !data.data) return;
            
            const recommendations = data.data;
            const container = document.getElementById('recommendations');
            if (!container) return;

            // Vérifier que recommendations est un tableau
            if (!Array.isArray(recommendations)) {
                container.innerHTML = '<p class="text-muted">Aucune recommandation pour le moment</p>';
                return;
            }

            const html = recommendations.map(rec => {
                const priorityClass = (rec.priority === 'high') ? 'danger' : (rec.priority === 'medium') ? 'warning' : 'info';
                const title = rec.title || 'Recommandation';
                const description = rec.description || 'Aucune description disponible';
                
                return `
                    <div class="alert alert-${priorityClass} d-flex align-items-center">
                        <i class="bi bi-lightbulb me-2"></i>
                        <div>
                            <strong>${title}</strong><br>
                            <small>${description}</small>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html || '<p class="text-muted">Aucune recommandation pour le moment</p>';
        }

        // Charger les analytics au démarrage
        document.addEventListener('DOMContentLoaded', function() {
            // Configuration d'authentification
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');
            let clientToken = localStorage.getItem('clientToken');
            
            if (tokenFromUrl) {
                localStorage.setItem('clientToken', tokenFromUrl);
                clientToken = tokenFromUrl;
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
            
            if (!clientToken) {
                window.location.href = '/access.html';
                return;
            }
            
            // Configuration globale pour toutes les requêtes fetch
            const originalFetch = window.fetch;
            window.fetch = function(url, options = {}) {
                if (!options.headers) {
                    options.headers = {};
                }
                
                if (url.includes('/api/') && !options.headers.Authorization) {
                    const token = localStorage.getItem('clientToken');
                    if (token) {
                        // Nettoyer le token des caractères indésirables
                        const cleanToken = token.trim().replace(/[\r\n\t]/g, '');
                        options.headers.Authorization = `Bearer ${cleanToken}`;
                        console.log('[FETCH] Token utilisé:', cleanToken.substring(0, 50) + '...');
                    } else {
                        console.log('[FETCH] Aucun token trouvé dans localStorage');
                    }
                }
                
                return originalFetch.call(this, url, options).catch(error => {
                    if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                        console.log('[FETCH] Erreur 401 - Token probablement invalide, redirection vers login');
                        localStorage.removeItem('clientToken');
                        window.location.href = '/access.html';
                    }
                    throw error;
                });
            };
            
            loadAdvancedAnalytics();
            
            // Refresh périodique des analytics (toutes les 3 minutes)
            setInterval(loadAdvancedAnalytics, 180000);
        });

        // Auto-refresh toutes les 2 minutes pour voir les nouvelles actions
        setInterval(() => {
            console.log('[AUTO-REFRESH] Actualisation automatique des actions...');
            loadActions();
        }, 120000); // 2 minutes
    </script>
</body>
</html>
